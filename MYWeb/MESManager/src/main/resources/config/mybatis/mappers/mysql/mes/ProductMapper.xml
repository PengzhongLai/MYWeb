<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mes.mapper.ProductMapper">
    <!--结果映射集-->
    <resultMap id="product" type="com.mes.domain.Product">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="source" property="source" />
        <result column="manufacturer" property="manufacturer" />
        <result column="placeSale" property="placeSale" />
        <result column="price" property="price" />
        <result column="shelfLife" property="shelfLife" />
        <result column="quantityNum" property="quantityNum" />
        <result column="addTime" property="addTime" />
        <result column="publishTime" property="publishTime" />
        <result column="publishState" property="publishState" />
        <result column="updateTime" property="updateTime" />
        <result column="description" property="description" />
        <result column="imgSrc" property="imgSrc" />
        <result column="good_comment_rate" property="goodCommentRate"/>
        <result column="row_num" property="rowNum" />
        <!--嵌套查询-->
       <!-- <association  column="id" property="evaluateList" select="queryEvaluateInfo"/>-->
        <collection column="id" property="evaluateList" javaType="ArrayList" select="queryEvaluateInfo"/>
    </resultMap>

    <select id="queryProductInfo" parameterType="hashmap" resultType="com.mes.domain.Product">
        SELECT
        *,
        ROW_NUMBER() OVER (ORDER BY id) AS row_num  -- 动态生成连续序号
        FROM tb_product_info
        <where>
            <!-- 支持按名称模糊查询 -->
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <!-- 支持按销售地查询 -->
            <if test="placeSale != null and placeSale != ''">
                AND placeSale IN (#{placeSale})
            </if>
            <!-- 支持按发布状态查询 -->
            <if test="publishState != null">
                AND publishState = #{publishState}
            </if>
        </where>
    </select>

    <update id="updateProduct" parameterType="com.mes.domain.Product">
        UPDATE tb_product_info
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="imgSrc != null">imgSrc = #{imgSrc},</if>
            <if test="source != null">source = #{source},</if>
            <if test="manufacturer != null">manufacturer = #{manufacturer},</if>
            <if test="placeSale != null">placeSale = #{placeSale},</if>
            <if test="price != null">price = #{price},</if>
            <if test="shelfLife != null">shelfLife = #{shelfLife},</if>
            <if test="quantityNum != null">quantityNum = #{quantityNum},</if>
            <if test="publishState != null">publishState = #{publishState},</if>
            <if test="publishTime != null">publishTime = #{publishTime},</if>
            updateTime = #{updateTime}
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteProductById" parameterType="int">
        DELETE FROM tb_product_info WHERE id = #{id}
    </delete>

    <insert id="addProduct" parameterType="com.mes.domain.Product"
            useGeneratedKeys="true" keyProperty="id">
        <!-- 原插入tb_product_info的SQL -->
        INSERT INTO tb_product_info (
        name, description, imgSrc, source, manufacturer,
        placeSale, price, shelfLife, quantityNum, addTime,
        publishTime, publishState, updateTime
        ) VALUES (
        #{name}, #{description}, #{imgSrc}, #{source}, #{manufacturer},
        #{placeSale}, #{price}, #{shelfLife}, #{quantityNum}, #{addTime},
        #{publishTime}, #{publishState}, #{updateTime}
        )
    </insert>

    <!--结果映射集-->
    <resultMap id="PETInfo" type="com.mes.domain.ProductEvaluateInfo">
        <id column="id" property="id" />
        <result column="mainId" property="mainId" />
        <result column="userId" property="userId" />
        <result column="evaluateInfo" property="evaluateInfo" />
        <result column="evaluateTime" property="evaluateTime" />
    </resultMap>
    <!--查询评价信息数据-->
    <select id="queryEvaluateInfo" parameterType="java.util.ArrayList" resultMap="PETInfo">
        SELECT  * FROM tb_pdt_evaluate_info
        WHERE mainId =#{id}
        ORDER BY evaluateTime desc
    </select>

    <!-- 查询好评率≥90的精选商品 -->
    <select id="queryFeaturedProducts" resultMap="product">
        SELECT
            p.*,
            s.good_comment_rate
        FROM
            tb_product_info p
                INNER JOIN
            tb_product_comment_stats s
            ON
                p.id = s.product_id
        WHERE
            s.good_comment_rate >= 90  -- 筛选好评率≥90的商品
          AND p.publishState = 1  -- 只显示已发布商品
        ORDER BY
            s.good_comment_rate DESC  -- 按好评率降序排列
    </select>

    <!-- 初始化商品评价统计记录 -->
    <insert id="initCommentStats" parameterType="int">
        INSERT INTO tb_product_comment_stats (
            product_id,
            good_comment_count,
            bad_comment_count,
            total_comment_count,
            good_comment_rate,
            update_time
        ) VALUES (
                     #{productId},
                     0,  -- 初始好评数为0
                     0,  -- 初始差评数为0
                     0,  -- 初始总评价数为0
                     0.00,  -- 初始好评率为0
                     NOW()  -- 更新时间为当前时间
                 )
    </insert>
</mapper>